name: Sistema de Cortes Mídia

on:
  repository_dispatch:
    types: [novo_relatorio]

jobs:
  preparar:
    name: preparar
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Sanity do payload
        shell: powershell
        run: |
          $url = "${{ github.event.client_payload.url }}"
          $rel = "${{ github.event.client_payload.relatorio }}"
          if (-not $url) { throw "client_payload.url vazio" }
          if (-not $rel) { throw "client_payload.relatorio vazio" }
          Write-Host "Payload OK. Job pesado vai aguardar aprovacao no Environment 'producao'."

  processamento:
    name: processamento
    needs: preparar
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    environment: producao
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Forçar UTF-8 no PowerShell
        shell: powershell
        run: |
          chcp 65001
          $OutputEncoding = [System.Text.UTF8Encoding]::new()
          [Console]::InputEncoding  = [System.Text.UTF8Encoding]::new()
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
          python -c "import sys; print(sys.version); print('stdout=', sys.stdout.encoding)"

      - name: Validar cookies/node/tools
        shell: powershell
        run: |
          $cookiePath = "D:\secrets\yt_cookies.txt"
          $nodePath   = "C:\nvm4w\nodejs\node.exe"

          if (!(Test-Path $cookiePath)) { throw "cookies.txt nao existe: $cookiePath" }
          Get-Content -Path $cookiePath -TotalCount 1 | Out-Null

          if (!(Test-Path $nodePath)) { throw "node.exe nao existe: $nodePath" }
          & $nodePath -v

          yt-dlp --version
          ffmpeg -version
          rclone version

      - name: Smoke test yt-dlp (list-formats)
        shell: powershell
        run: |
          $url = "${{ github.event.client_payload.url }}"
          if ($url -match "\((https?://[^)]+)\)") { $url = $Matches[1] }
          $url = $url.Trim()

          yt-dlp --cookies "D:\secrets\yt_cookies.txt" `
                --remote-components ejs:github `
                --js-runtimes "node:C:\nvm4w\nodejs\node.exe" `
                -4 --retries 3 --fragment-retries 3 --retry-sleep "exp=1:10:2" `
                --list-formats "$url" | Out-Null

          Write-Host "OK: yt-dlp passou no smoke test."

      - name: Executar Motor de Corte
        shell: powershell
        run: |
          chcp 65001
          $OutputEncoding = [System.Text.UTF8Encoding]::new()
          [Console]::InputEncoding  = [System.Text.UTF8Encoding]::new()
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
          python -X utf8 processar_cortes.py --event-path "${{ github.event_path }}"
