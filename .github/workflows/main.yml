name: Sistema de Cortes MÃ­dia

on:
  repository_dispatch:
    types: [novo_relatorio]

jobs:
  processamento:
    name: processamento
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
      PYTHONLEGACYWINDOWSSTDIO: "utf-8"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Mostrar SHA
        shell: powershell
        run: |
          echo "github.sha = ${{ github.sha }}"
          git rev-parse HEAD
          echo "workflow_sha = ${{ github.workflow_sha }}"

      - name: Identidade do runner
        shell: powershell
        run: |
          whoami
          echo "UserProfile=$env:USERPROFILE"
          echo "Path=$env:PATH"

      - name: Validar cookies/node/tools (inclui ACL)
        shell: powershell
        run: |
          $cookiePath = "D:\secrets\yt_cookies.txt"
          $nodePath   = "C:\nvm4w\nodejs\node.exe"

          if (!(Test-Path $cookiePath)) { throw "cookies.txt nao existe: $cookiePath" }

          Write-Host "ACL do cookies.txt:"
          icacls $cookiePath

          Get-Content -Path $cookiePath -TotalCount 1 | Out-Null
          Write-Host "OK: cookies.txt existe e pode ser lido"

          if (!(Test-Path $nodePath)) { throw "node.exe nao existe: $nodePath" }
          & $nodePath -v

          yt-dlp --version
          ffmpeg -version

      - name: Smoke test yt-dlp (list-formats)
        shell: powershell
        run: |
          $url = "${{ github.event.client_payload.url }}"
          if ($url -match "\((https?://[^)]+)\)") { $url = $Matches[1] }
          $url = $url.Trim()

          yt-dlp --cookies "D:\secrets\yt_cookies.txt" `
                --remote-components ejs:github `
                --js-runtimes "node:C:\nvm4w\nodejs\node.exe" `
                -4 --retries 3 --fragment-retries 3 --retry-sleep "exp=1:10:2" `
                --list-formats "$url"

      - name: Executar Motor de Corte
        shell: powershell
        run: python -X utf8 processar_cortes.py --event-path "${{ github.event_path }}"
