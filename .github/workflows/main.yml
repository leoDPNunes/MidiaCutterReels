name: Sistema de Cortes Midia

on:
  repository_dispatch:
    types: [novo_relatorio]

jobs:
  preparar:
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3

      - name: Sanity minima (sem parse de JSON)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $eventPath = $env:GITHUB_EVENT_PATH
          if (-not $eventPath) { throw "GITHUB_EVENT_PATH vazio" }

          if (!(Test-Path -LiteralPath $eventPath -PathType Leaf)) {
            throw "Arquivo do evento nao existe: $eventPath"
          }

          $len = (Get-Item -LiteralPath $eventPath).Length
          if ($len -lt 20) { throw "Arquivo do evento muito pequeno ($len bytes): $eventPath" }

          "OK: evento presente ($len bytes). Aguardando aprovacao do environment."

  processamento:
    needs: preparar
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    environment: producao
    timeout-minutes: 360

    env:
      PYTHONUTF8: "1"
      PYTHONIOENCODING: utf-8

    steps:
      - uses: actions/checkout@v3

      - name: Validar ferramentas (sem payload)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          yt-dlp --version
          ffmpeg -version
          rclone version
          python -c "import sys; print(sys.version); print('stdout=', sys.stdout.encoding)"

      - name: Executar motor (somente via arquivo do evento)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          python -X utf8 processar_cortes.py --event-path "$env:GITHUB_EVENT_PATH"
