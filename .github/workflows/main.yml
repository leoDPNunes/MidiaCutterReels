name: Sistema de Cortes Midia

on:
  repository_dispatch:
    types: [novo_relatorio]

jobs:
  preparar:
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3

      - name: Sanity minima (sem ler JSON)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $eventPath = $env:GITHUB_EVENT_PATH
          if (-not $eventPath) { throw "GITHUB_EVENT_PATH vazio" }
          if (!(Test-Path -LiteralPath $eventPath)) { throw "Arquivo do evento nao existe: $eventPath" }
          $len = (Get-Item -LiteralPath $eventPath).Length
          if ($len -lt 10) { throw "Arquivo do evento muito pequeno ($len bytes): $eventPath" }
          "OK: evento presente em $eventPath ($len bytes)"

  processamento:
    needs: preparar
    runs-on: [self-hosted, Windows, X64, midia-cutter]
    environment: producao
    timeout-minutes: 360

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    steps:
      - uses: actions/checkout@v3

      - name: Validar ferramentas (sem payload)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          yt-dlp --version
          ffmpeg -version
          rclone version
          python -c "import sys; print(sys.version); print('stdout=', sys.stdout.encoding)"

      - name: Executar motor (somente via GITHUB_EVENT_PATH)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          python -X utf8 processar_cortes.py --event-path "$env:GITHUB_EVENT_PATH"
